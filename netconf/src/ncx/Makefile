# Makefile for NETCONF project
#  
#   ncx directory

############### SOURCE PROFILE ##############################

SUBDIR_NM=ncx
SUBDIR_CPP=

############### TARGET PROFILE ##############################

TARGET=$(TBASE)/$(SUBDIR_NM)
LIB_INST=$(TBASE)/lib

ifdef MAXWELL
REAL_INST=/lib
else
REAL_INST=$(DESTDIR)/usr/lib
endif

# if the target is DEBIAN or RPM package, then
# install the include files
REAL_INC_INST=$(DESTDIR)/usr/include/yuma

######################### MAKE RULES ######################

all: ncxdummy ncxlib

#################### PLATFORM DEFINITIONS ############
include ../platform/platform.profile

################ DEPENDENCIES #########################
# depend rule must be included after the 'all' make rule

include ../platform/platform.profile.depend

ifdef DEBIAN
BLD_INCLUDES=
else
BLD_INCLUDES=includes
endif

test:

# build the library in any developer context
# and in the 1-pass RPM RELEASE build
# for ubunte RELEASE builds, only build if 
# this is the SHLIBS pass, not CLIENT, SERVER, or DEVELOPER
ifdef SERVER
# nothing to do for debian SERVER build
install:
else
ifdef CLIENT
# nothing to do for debian CLIENT build
install:
else
ifdef DEVELOPER
# just install the H files
install: includes
else
install: $(BLD_INCLUDES)
ifndef STATIC
# install dynamic libncx file
	mkdir -p $(REAL_INST)
	install $(OWNER) $(GRP) \
	$(LIB_INST)/lib$(SUBDIR_NM).$(LIBNCXSUFFIX) $(REAL_INST)
#ifdef SHLIBS
# libncx.so --> libncx.so.M.N
# libncx.so.1 --> libncx.so.M.N
	(cd $(REAL_INST); \
	ln -f -s lib$(SUBDIR_NM).$(LIBNCXSUFFIX) \
	lib$(SUBDIR_NM).$(LIBSUFFIX);\
	ln -f -s lib$(SUBDIR_NM).$(LIBNCXSUFFIX) \
	lib$(SUBDIR_NM).$(LIBSUFFIX).$(LIBNCX_MAJOR_VERSION))
#endif
ifndef DESTDIR
ifndef MAC
# skip in MacOsX, RPM, and rest of debian fakeroot builds
	ldconfig
endif
endif
endif
endif
endif
endif

# 1 librarr uninstall rule for all variants
# TBD: uninstall includes
uninstall:
	rm -f $(REAL_INST)/lib$(SUBDIR_NM).$(LIBSUFFIX)*


# check which variant of the library to build
ifdef SERVER
ncxlib:
else
ifdef CLIENT
ncxlib:
else
ifdef DEVELOPER
ncxlib:
else
ncxlib: $(LBASE)/lib$(SUBDIR_NM).$(LIBNCXSUFFIX)
ifndef STATIC
	(cd $(LBASE); ln -f -s lib$(SUBDIR_NM).$(LIBNCXSUFFIX) \
	lib$(SUBDIR_NM).$(LIBSUFFIX))
endif
endif
endif
endif

# this dummy rule keeps make from deleting the $(OBJS) as
# intermediate files
ncxdummy: dependencies $(OBJS)

clean:
	rm -f $(OBJS) $(LBASE)/lib$(SUBDIR_NM).*

superclean:
	rm -f *~  $(DEPS) dependencies $(OBJS) \
	$(LBASE)/lib$(SUBDIR_NM).*

distclean: superclean uninstall

# this rule is ignored if STATIC=1; used only in linux
$(LBASE)/libncx.so.$(SOVERSION): $(OBJS)
	gcc -shared -rdynamic -Wl,-soname,libncx.so.$(SOVERSION) \
	-o $@ $(OBJS) -lc

# this rule is ignored if STATIC=1; used only on MacOSX
$(LBASE)/libncx.dylib: $(OBJS)
	gcc -shared -dynamiclib -std=gnu99 -current_version \
	$(SOVERSION) \
	-undefined dynamic_lookup \
	-o $@ -install_name libncx.dylib $(OBJS) -lxml2


# install the H files into $DESTDIR/usr/include
includes:
ifndef SHLIBS
ifndef SERVER
ifndef CLIENT
	mkdir -p $(REAL_INC_INST)/ncx
	mkdir -p $(REAL_INC_INST)/platform
	cp *.h $(REAL_INC_INST)/ncx
	cp ../platform/procdefs.h $(REAL_INC_INST)/platform
endif
endif
endif

.PHONY: includes

# prevent the make program from choking on all the symbols
# that get generated from autogenerated make rules
.NOEXPORT:

ifndef DEVELOPER
include dependencies
endif

